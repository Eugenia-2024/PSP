package ejerciciosNoEvaluables;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

public class SimuladorSeguroMalware {

    public static void main(String[] args){

        final int REPETICIONES = 20;

        // Rutas/commands: en Windows típico
        String notepadCmd = "notepad.exe";
        // Intentamos la ruta por defecto de Firefox; si no existe, usaremos un fallback.
        String firefoxPath = "C:\\Program Files\\Mozilla Firefox\\firefox.exe";

        for (int i = 1; i <= REPETICIONES; i++) {
            System.out.println("=== Iteración " + i + " de " + REPETICIONES + " ===");

            List<Process> procesos = new ArrayList<>();

            // Lanzar Notepad usando ProcessBuilder
            try {
                ProcessBuilder pbNotepad = new ProcessBuilder(notepadCmd);
                Process pNotepad = pbNotepad.start();
                procesos.add(pNotepad);
                System.out.println("Lanzado Notepad (pid aprox.): " + pNotepad);
            } catch (IOException e) {
                System.out.println("No se pudo lanzar notepad: " + e.getMessage());
            }

            // Lanzar Firefox si existe, si no lanzar un comando inofensivo (ping corto)
            try {
                File ff = new File(firefoxPath);
                Process pFirefox;
                if (ff.exists()) {
                    pFirefox = new ProcessBuilder(firefoxPath).start();
                    System.out.println("Lanzado Firefox (ruta encontrada).");
                } else {
                    // Fallback: comando inofensivo que dura 2 segundos en Windows
                    pFirefox = new ProcessBuilder("cmd", "/c", "ping", "127.0.0.1", "-n", "3").start();
                    System.out.println("Firefox no encontrado; lanzado proceso fallback (ping corto).");
                }
                procesos.add(pFirefox);
            } catch (IOException e) {
                System.out.println("No se pudo lanzar firefox ni fallback: " + e.getMessage());
            }

            // Esperar 1 segundo (simula comportamiento del ejercicio)
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                System.out.println("Hilo interrumpido.");
            }

            // Abrir "Explorador" de forma segura: usar explorer.exe si está disponible
            try {
                Process pExplorer = new ProcessBuilder("explorer.exe").start();
                System.out.println("Lanzado Explorador de archivos.");
                // No guardamos pExplorer en la lista de destrucción para mantenerlo abierto
            } catch (IOException e) {
                System.out.println("No se pudo lanzar explorer: " + e.getMessage());
            }

            // Cerrar los procesos anteriores (notepad y firefox/fallback) si están vivos
            for (Process proc : procesos) {
                if (proc != null) {
                    boolean alive = proc.isAlive();
                    System.out.println("Proceso " + proc + " está vivo? " + alive);
                    if (alive) {
                        // Intentamos destruir el proceso de forma amistosa.
                        proc.destroy();
                        // Esperamos un poco y si sigue vivo forzamos.
                        try {
                            Thread.sleep(200);
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                        }
                        if (proc.isAlive()) {
                            proc.destroyForcibly();
                        }
                        System.out.println("Se solicitó cierre del proceso " + proc);
                    }
                }
            }

            // Un ligero retraso antes de la siguiente iteración para que no sea instantáneo
            try {
                Thread.sleep(300);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }

        // Esperar 5 segundos tal como indica la práctica
        System.out.println("Ciclos completados. Esperando 5 segundos...");
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }

        // Mensaje final en lugar de apagar/reiniciar
        System.out.println("Simulación finalizada correctamente. (Por seguridad no se apaga el sistema).");
    }

}
